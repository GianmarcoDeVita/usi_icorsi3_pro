<script>
function doForEach(items, f) {
  if (items && f) {
    for (let i = 0; i < items.length; i++) {
      f(items[i]);
    }
  }
}

function removeFooter() {
  doForEach(document.getElementsByTagName('footer'), x => x.outerHTML = '');
}

function removeNews() {
  const newsDiv = document.getElementById('messagesbyinstitution');
  if (newsDiv) {
      newsDiv.outerHTML = '';
  }
}

function properLogo(config) {
  doForEach(document.getElementsByClassName('logo'), x => x.src = config.logo);
  doForEach(document.getElementsByClassName('site-name'), x => x.innerHTML = '<span>i3corsi<sup>pro</sup><span>');
}

function formatTime(date) {
  const twoDigits = (n) => n < 10 ? '0' + n : n;
  return twoDigits(date.getHours()) + ':' + twoDigits(date.getMinutes());
}

function injectUsiSchedule(config) {
  // Cache 'now' values
  let now = new Date();
  now = {
    time: now.getTime(),
    year: now.getFullYear(),
    month: now.getMonth(),
    day: now.getDate(),
  };

  // Fetch schedule through the API wrapper to bypass CORS
  fetch(`https://soulsbros.ch/proxy/schedule.php?studyPlan=${config.studyPlan}&semester=${config.semester}&studyYear=${config.studyYear}`)
    .then(res => res.json())
    .then(res => res.data)
    .then(courses => courses.filter(course => {
        // filter today's courses that haven't ended yet
        const when = new Date(course.end);
        return when.getTime() > now.time
            && when.getFullYear() === now.year
            && when.getMonth() === now.month
            && when.getDate() === now.day;
      }).map(course => {
        // Map to proper data structure
        const info = course.course;
        const name = info['name_en'] || info['name_it'];
        const lecturers = info.lecturers.data
          .map(x => x.person)
          .map(x => `${x.last_name} ${x.first_name}`)
          .join(', ');
        const location = course.place.office;
        const time = {
          start: new Date(course.start),
          end: new Date(course.end),
        };
        return { name, lecturers, location, time };
      })
      .sort((a, b) => a.time.end.getTime() - b.time.end.getTime())
    ).then(data => doForEach(document.getElementsByClassName('fpstartwrap'), x => {
      const table = document.createElement('div');
      table.className = 'my-schedule-table';
      if (data.length === 0) {
        table.innerHTML = '<p>All done for today!</p>';
      } else {
        data.forEach((it, i) => {
          const column = document.createElement('div');
          column.className = 'my-schedule-column';
          const title = document.createElement('h4');
          title.innerText = `${i + 1}: ${it.name}`;
          column.appendChild(title);
          const info = document.createElement('div');
          info.innerHTML = `<p>${it.lecturers}<br>
                            <b>${it.location}</b>\t
                            From ${formatTime(it.time.start)}
                            to ${formatTime(it.time.end)}</p>`;
          column.appendChild(info);
          table.appendChild(column);
        });
      }
      // Clear header contents
      x.innerHTML = '';
      const scheduleTitle = document.createElement('h3');
      scheduleTitle.innerText = 'Schedule for today';
      x.appendChild(scheduleTitle);
      // Inject schedule
      x.appendChild(table);
    }));
}

window.onload = () => {
  const config = {
    logo: 'https://github.com/bvlj/usi_icorsi3_pro/raw/main/logo.svg',
    studyPlan: '59',  // msde
    semester: '51',   // SA2021
    studyYear: '1',   // 1st year
  };
  properLogo(config);
  removeFooter();
  removeNews();
  injectUsiSchedule(config);
};
</script>

<style>
.my-schedule-table {
  display: flex;
  flex-flow: row wrap;
  gap: 12px;
}

.my-schedule-table .my-schedule-column {
  display: flex;
  flex-basis: 100%;
  flex-flow: column nowrap;
  padding: 4px;
}

::-webkit-scrollbar {
  background-color: transparent;
}
::-webkit-scrollbar-track {
  background-color: transparent;
}
::-webkit-scrollbar-track-piece {
  background-color: transparent;
}
</style>
