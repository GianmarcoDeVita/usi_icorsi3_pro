<script>
function doForEach(items, f) {
  if (!items) return;
  for (let i = 0; i < items.length; i++) { f(items[i]); }
}

function removeFooter() {
  doForEach(document.getElementsByTagName('footer'), x => x.outerHTML = '');
}

function removeNews() {
  const newsDiv = document.getElementById('messagesbyinstitution');
  if (newsDiv) {
      newsDiv.outerHTML = '';
  }
}

function properLogo() {
  const myLogo = 'https://github.com/bvlj/usi_icorsi3_pro/raw/main/logo.svg';
  doForEach(document.getElementsByClassName('logo'), x => x.src = myLogo);
  doForEach(document.getElementsByClassName('site-name'), x => x.innerHTML = '<span>i3corsi<sup>pro</sup><span>');
}

function roomStatus(room) {
  return new Promise((resolve, _) => {
    const xhr = new XMLHttpRequest();
    xhr.addEventListener('load', () => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xhr.responseText, 'text/html');
      const lessons = doc.querySelectorAll(
        'table.rsContentTable div.rsAptSimple'
      );
      const parsed = [];
      for (let lesson of lessons) {
        const time = lesson.querySelector('span[id$=lblOrario]');
        const start = new Date();
        start.setHours(parseInt(time.innerText.substring(1, 3)));
        start.setMinutes(parseInt(time.innerText.substring(4, 6)));
        start.setSeconds(0);
        const end = new Date();
        end.setHours(parseInt(time.innerText.substring(7, 9)));
        end.setMinutes(parseInt(time.innerText.substring(10, 12)));
        end.setSeconds(0);

        parsed.push({
          title: lesson.getAttribute('title')
            .replace(/S[AP] \d+-\d+/, '')
            .replace('(INF)', '')
            .trim(),
          start: start,
          end: end,
        });
      }
      resolve(parsed);
    });

    // Simple proxy to https://aule.usi.ch/aule/View.aspx?name=
    xhr.open('GET', `https://soulsbros.ch/steeven/aule.php?name=${room}`);
    xhr.send();
  });
}

function formatTime(date) {
  const twoDigits = (n) => n < 10 ? '0' + n : n;
  return twoDigits(date.getHours()) + ':' + twoDigits(date.getMinutes());
}

function injectUsiSchedule() {
  const study_plan = '59';  // msde
  const semester = '51';    // SA2021
  const study_year = '1';   // 1st year
  const now = new Date();
  fetch(`https://soulsbros.ch/proxy/schedule.php?studyPlan=${study_plan}&semester=${semester}&studyYear=${study_year}`)
    .then(res => res.json())
    .then(res => res.data)
    .then(courses => courses.filter(course => {
        const when = new Date(course.start);
        return when.getFullYear() === now.getFullYear()
            && when.getMonth() === now.getMonth()
            && when.getDate() === now.getDate();
      }).map(course => {
        const info = course.course;
        const name = info['name_en'] || info['name_it'];
        const lecturers = info.lecturers.data
          .map(x => x.person)
          .map(x => `${x.last_name} ${x.first_name}`)
          .join(', ');
        const location = course.place.office;
        const time = {
          start: new Date(course.start),
          end: new Date(course.end),
        };
        return { name, lecturers, location, time };
      })
      .sort((a, b) => a.time.start.getTime() - b.time.end.getTime()))
    .then(data => doForEach(document.getElementsByClassName('fpstartwrap'), x => {
      const table = document.createElement('div');
      table.className = 'my-schedule-table';
      data.forEach((it, i) => {
        const column = document.createElement('div');
        column.className = 'my-schedule-column';
        const title = document.createElement('h4');
        title.innerText = `${i + 1}: ${it.name}`;
        column.appendChild(title);
        const info = document.createElement('div');
        info.innerHTML = `${it.lecturers}<br>
                          <b>${it.location}</b>\t
                          From ${formatTime(it.time.start)}
                          to ${formatTime(it.time.end)}`;
        column.appendChild(info);
        table.appendChild(column);
      });
      x.innerHTML = '';
      const scheduleTitle = document.createElement('h3');
      scheduleTitle.innerText = 'Schedule for today';
      x.appendChild(scheduleTitle);
      x.appendChild(table);
    }));
}

window.onload = () => {
  properLogo();
  removeFooter();
  removeNews();
  injectUsiSchedule();
};
</script>

<style>
.my-schedule-table {
  display: flex;
  flex-flow: row wrap;
  flex-basis: 50%;
  gap: 12px;
  justify-content: space-between;
}

.my-schedule-table .my-schedule-column {
  display: flex;
  flex-basis: 100%;
  flex-flow: column nowrap;
  padding: 4px;
}

::-webkit-scrollbar {
  background-color: transparent;
}
::-webkit-scrollbar-track {
  background-color: transparent;
}
::-webkit-scrollbar-track-piece {
  background-color: transparent;
}
</style>
